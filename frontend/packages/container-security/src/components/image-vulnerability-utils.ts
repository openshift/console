import { Vulnerability } from '../types';

export enum VulnerabilitiesType {
  allVulnerabilities = 'All vulnerabilities',
  appDependency = 'App dependency',
  baseImage = 'Base image',
}

const vulnerabilityMetadata = (vulnerability: Vulnerability) => {
  if (!vulnerability?.metadata) return undefined;
  try {
    return JSON.parse(vulnerability.metadata);
  } catch {
    return vulnerability.metadata;
  }
};

const isSynkVuln = (vulnerability: Vulnerability) => {
  const metadata = vulnerabilityMetadata(vulnerability);
  return metadata?.UpdatedBy === 'CodeReadyAnalytics';
};

export const getVulnerabilityType = (vulnerability: Vulnerability) =>
  isSynkVuln(vulnerability) ? VulnerabilitiesType.appDependency : VulnerabilitiesType.baseImage;

export const getVulnerabilitySource = (vulnerability: Vulnerability) =>
  isSynkVuln(vulnerability) ? 'Snyk' : 'Red Hat';

export const getFixableVulnerabilitiesCount = (vulnerabilities: Vulnerability[]) =>
  vulnerabilities?.filter(
    (vulnerability) => vulnerability.fixedby !== null || vulnerability.fixedby !== '',
  ).length;

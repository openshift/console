import * as React from 'react';
import { shallow, ShallowWrapper } from 'enzyme';
import { SecurityIcon } from '@patternfly/react-icons';
import { TableData } from '@console/internal/components/factory';
import { ExternalLink } from '@console/internal/components/utils';
import { fakeVulnFor } from '../../../integration-tests/bad-pods';
import { Priority, vulnPriority } from '../../const';
import ImageVulnerabilityRow from '../ImageVulnerabilityRow';

describe('ImageVulnerabilityRow', () => {
  type ImageVulnerabilityRowProps = React.ComponentProps<typeof ImageVulnerabilityRow>;
  let wrapper: ShallowWrapper<ImageVulnerabilityRowProps>;
  const vuln = fakeVulnFor(Priority.Critical);
  const props: ImageVulnerabilityRowProps = {
    obj: {
      feature: vuln.spec.features[0],
      vulnerability: vuln.spec.features[0].vulnerabilities[0],
    },
    index: 1,
    key: '',
    style: {},
    isScrolling: false,
    columns: [],
  };

  beforeEach(() => {
    wrapper = shallow(<ImageVulnerabilityRow {...props} />);
  });

  it('renders a `SecurityIcon` with the correct color for the severity', () => {
    expect(wrapper.find(SecurityIcon).props().color).toEqual(
      vulnPriority.get(Priority.Critical).color.value,
    );
  });

  it('should render 7 column', () => {
    expect(wrapper.find(TableData)).toHaveLength(7);
  });
  it('should render Vulnerability column', () => {
    const vulnerabilityColumn = wrapper.find(TableData).at(0);
    expect(vulnerabilityColumn.find(ExternalLink).props().text).toBe('RHSA-2019:1880');
    expect(vulnerabilityColumn.find(ExternalLink).props().href).toBe(
      'https://access.redhat.com/errata/RHSA-2019:1880',
    );
  });
  it('should render Package column', () => {
    const vulnerabilityColumn = wrapper.find(TableData).at(2);
    expect(vulnerabilityColumn.props().children).toBe('libcurl');
  });
  it('should render Type column', () => {
    const vulnerabilityColumn = wrapper.find(TableData).at(3);
    expect(vulnerabilityColumn.props().children).toBe('Base image');
  });
  it('should render Source column', () => {
    const vulnerabilityColumn = wrapper.find(TableData).at(4);
    expect(vulnerabilityColumn.props().children).toBe('Red Hat');
  });
  it('should render Current Version column', () => {
    const vulnerabilityColumn = wrapper.find(TableData).at(5);
    expect(vulnerabilityColumn.props().children).toBe('7.29.0-51.el7');
  });
  it('should render Fixed in Version column', () => {
    const vulnerabilityColumn = wrapper.find(TableData).at(6);
    expect(vulnerabilityColumn.props().children).toBe('0:7.29.0-51.el7_6.3');
  });
});
